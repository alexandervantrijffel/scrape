package sourceycombinator

import (
	"fmt"
	"testing"

	"github.com/alexandervantrijffel/goutil/logging"
	"github.com/alexandervantrijffel/scrape/config"
	"github.com/stretchr/testify/assert"
)

func TestJsonToArticles(t *testing.T) {
	logging.InitWith("scrape_test", config.DEBUG)
	data := `
{"articles":[{"contentLink":"https://www.findchips.com/","title":"1.FindChips – Get instant insight into any electronic component (findchips.com)"},{"contentLink":"https://char.gd/blog/2019/google-news-is-broken","title":"2.How does one appear in the Google News carousel? (char.gd)"},{"contentLink":"https://github.com/TheBerkin/rant","title":"3.Rant – An all-purpose procedural text engine (github.com)"},{"contentLink":"https://medium.com/@jeffreypbezos/no-thank-you-mr-pecker-146e3922310f","title":"4.No Thank You, Mr. Pecker (medium.com)"},{"contentLink":"https://wickedchicken.github.io/post/german-for-programmers/","title":"5.German for Programmers (wickedchicken.github.io)"},{"contentLink":"https://techcrunch.com/2019/02/07/apple-glassbox-apps/","title":"6. Apple tells app developers to disclose or remove screen recording code (techcrunch.com)"},{"contentLink":"https://rachelandrew.co.uk/archives/2019/01/30/html-css-and-our-vanishing-industry-entry-points/","title":"7.HTML, CSS and our vanishing industry entry points (rachelandrew.co.uk)"},{"contentLink":"https://leebriggs.co.uk/blog/2019/02/07/why-are-we-templating-yaml.html","title":"8.Why are we templating YAML? (leebriggs.co.uk)"},{"contentLink":"https://opensource.googleblog.com/2019/02/open-sourcing-clusterfuzz.html","title":"9.Open-Sourcing ClusterFuzz (googleblog.com)"},{"contentLink":"https://dannyvankooten.com/from-go-back-to-php-again/","title":"10.Moving from Go to PHP Again (dannyvankooten.com)"},{"contentLink":"https://www.eff.org/deeplinks/2019/02/countries-zero-rating-have-more-expensive-wireless-broadband-countries-without-it","title":"11.Countries With Zero Rating Have More Expensive Wireless (eff.org)"},{"contentLink":"https://www.bloomberg.com/opinion/articles/2019-02-07/eternal-market-patience-offers-eternal-rewards","title":"12.Crunching 200 years of stock, bond, currency and commodity data (bloomberg.com)"},{"contentLink":"https://logicmag.io/06-money-machines/","title":"13.Money Machines – An Interview with an Anonymous Algorithmic Trader (logicmag.io)"},{"contentLink":"https://segment.com/blog/when-aws-autoscale-doesn-t/","title":"14.When AWS Autoscale Doesn’t (segment.com)"},{"contentLink":"https://github.com/trimstray/nginx-quick-reference","title":"15.Nginx quick reference (github.com)"},{"contentLink":"https://research.kudelskisecurity.com/2019/02/07/auditing-rust-crypto-the-first-hours/","title":"16.Auditing Rust Crypto: The First Hours (kudelskisecurity.com)"},{"contentLink":"https://www.nccgroup.trust/us/about-us/newsroom-and-events/blog/2019/february/downgrade-attack-on-tls-1.3-and-vulnerabilities-in-major-tls-libraries/","title":"17.Downgrade Attack on TLS 1.3 and Vulnerabilities in Major TLS Libraries (nccgroup.trust)"},{"contentLink":"https://www.chiark.greenend.org.uk/~sgtatham/coroutines.html","title":"18.Coroutines in C (2000) (greenend.org.uk)"},{"contentLink":"https://www.nytimes.com/2019/02/07/opinion/what-these-grammy-songs-tell-us-about-the-loudness-wars.html","title":"19.They Don’t Make Music Like They Used To (nytimes.com)"},{"contentLink":"https://www.latimes.com/business/technology/la-fi-tn-amazon-drivers-tips-20190207-story.html","title":"20.Where does a tip to an Amazon driver go? Sometimes, toward the driver's base pay (latimes.com)"},{"contentLink":"https://edition.cnn.com/2019/02/07/business/qantas-airbus-a380/index.html","title":"21.A380 cancellations by Qantas raise new questions about the superjumbo's future (cnn.com)"},{"contentLink":"http://www.irisonboard.com/careers/","title":"22.Iris Automation Is Hiring a Computer Vision Expert – AI for Drones (irisonboard.com)"},{"contentLink":"https://blog.floydhub.com/similar-fashion-images/","title":"23.Building a fashion search engine with deep learning (floydhub.com)"},{"contentLink":"https://climatetoolbox.org/","title":"24.The Northwest Climate Toolbox (climatetoolbox.org)"},{"contentLink":"item?id=19108115","title":"25.Tell HN: Wells Fargo completely offline"},{"contentLink":"https://www.bbc.co.uk/news/technology-47160448","title":"26.Ocado's burning robotic warehouse (bbc.co.uk)"},{"contentLink":"https://blog.ycombinator.com/a-strategic-guide-to-preemptive-funding-offers/","title":"27.A Guide to Preemptive Funding Offers (ycombinator.com)"},{"contentLink":"https://medium.com/@shl/reflecting-on-my-failure-to-build-a-billion-dollar-company-b0c31d7db0e7","title":"28.Reflecting on My Failure to Build a Billion-Dollar Company (medium.com)"},{"contentLink":"http://histscifi.com/essays/radin/technothriller","title":"29.Michael Crichton, Science Studies, and the Technothriller (2015) (histscifi.com)"},{"contentLink":"https://github.com/mesibo/messenger-app-android","title":"30.Open Source Messenger App for Android – Real-Time Messaging, Voice and Video (github.com)"}],"subtexts":[{"comments":"46 comments","score":"236 points","ycombinatorLink":"item?id=19110698"},{"comments":"109 comments","score":"239 points","ycombinatorLink":"item?id=19110041"},{"comments":"13 comments","score":"91 points","ycombinatorLink":"item?id=19111816"},{"comments":"415 comments","score":"1690 points","ycombinatorLink":"item?id=19109474"},{"comments":"116 comments","score":"217 points","ycombinatorLink":"item?id=19109371"},{"comments":"241 comments","score":"501 points","ycombinatorLink":"item?id=19109027"},{"comments":"173 comments","score":"321 points","ycombinatorLink":"item?id=19106922"},{"comments":"234 comments","score":"191 points","ycombinatorLink":"item?id=19108787"},{"comments":"77 comments","score":"262 points","ycombinatorLink":"item?id=19106771"},{"comments":"124 comments","score":"172 points","ycombinatorLink":"item?id=19111358"},{"comments":"153 comments","score":"219 points","ycombinatorLink":"item?id=19106475"},{"comments":"108 comments","score":"267 points","ycombinatorLink":"item?id=19106658"},{"comments":"60 comments","score":"146 points","ycombinatorLink":"item?id=19108017"},{"comments":"80 comments","score":"176 points","ycombinatorLink":"item?id=19106767"},{"comments":"10 comments","score":"76 points","ycombinatorLink":"item?id=19112090"},{"comments":"71 comments","score":"122 points","ycombinatorLink":"item?id=19108206"},{"comments":"30 comments","score":"153 points","ycombinatorLink":"item?id=19111707"},{"comments":"54 comments","score":"155 points","ycombinatorLink":"item?id=19106796"},{"comments":"56 comments","score":"77 points","ycombinatorLink":"item?id=19108781"},{"comments":"70 comments","score":"132 points","ycombinatorLink":"item?id=19109455"},{"comments":"197 comments","score":"104 points","ycombinatorLink":"item?id=19106772"},{"comments":"hide","score":"","ycombinatorLink":"hide?id=19112423\u0026goto=news"},{"comments":"13 comments","score":"76 points","ycombinatorLink":"item?id=19107831"},{"comments":"4 comments","score":"44 points","ycombinatorLink":"item?id=19108911"},{"comments":"211 comments","score":"276 points","ycombinatorLink":"item?id=19108115"},{"comments":"52 comments","score":"61 points","ycombinatorLink":"item?id=19110215"},{"comments":"12 comments","score":"83 points","ycombinatorLink":"item?id=19106524"},{"comments":"333 comments","score":"1888 points","ycombinatorLink":"item?id=19105733"},{"comments":"8 comments","score":"14 points","ycombinatorLink":"item?id=19098233"},{"comments":"8 comments","score":"39 points","ycombinatorLink":"item?id=19111250"}]}
	`
	articles, err := jsonToArticles([]byte(data))
	if err != nil {
		assert.Fail(t, err.Error())
	}
	assert.NotEmpty(t, articles)
	first := articles[0]
	assert.Equal(t, "1.FindChips – Get instant insight into any electronic component (findchips.com)", first.Title)
	assert.Equal(t, 46, first.Comments)
	assert.Equal(t, 236, first.Score)

	top := TopArticles(articles)
	logging.Infof("Top %+v", top)
	assert.Equal(t, 236, articles[0].Score)
	for _, a := range top {
		assert.True(t, a.Score >= 150, fmt.Sprintf("Below 150! %+v", a))
	}
}
